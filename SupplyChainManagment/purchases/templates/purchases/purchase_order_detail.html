{% extends "blank.html" %}
{% load static %}

{% block title %}{{ po.po_number }} - Purchase Order Details{% endblock %}

{% block content %}
<div class="bg-gray-100 min-h-screen">
    <div class="container mx-auto p-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Purchase Order: {{ po.po_number }}</h1>
                <p class="text-gray-600 mt-2">Detailed view of purchase order</p>
            </div>
            <a href="{% url 'purchases:purchase_order_list' %}" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center">
                <i class="fas fa-arrow-left mr-2"></i> Back to Orders
            </a>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-8">
                <!-- PO Header Info -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6">Purchase Order Details</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">PO Number:</span>
                                <span class="text-gray-900 font-semibold">{{ po.po_number }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Supplier:</span>
                                <span class="text-gray-900">{{ po.supplier.name }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Status:</span>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full {% if po.status == 'draft' %}bg-gray-100 text-gray-800{% elif po.status == 'sent' %}bg-yellow-100 text-yellow-800{% elif po.status == 'confirmed' %}bg-blue-100 text-blue-800{% elif po.status == 'received' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                    {{ po.get_status_display }}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Total Amount:</span>
                                <span class="text-2xl font-bold text-green-600">${{ po.total_amount|floatformat:2 }}</span>
                            </div>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Created Date:</span>
                                <span class="text-gray-900">{{ po.created_date|date:"M d, Y g:i A" }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Created By:</span>
                                <span class="text-gray-900">{{ po.created_by.get_full_name|default:po.created_by.username }}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Expected Delivery:</span>
                                <span class="text-gray-900">
                                    {% if po.expected_delivery_date %}
                                        {{ po.expected_delivery_date|date:"M d, Y" }}
                                    {% else %}
                                        Not specified
                                    {% endif %}
                                </span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600 font-medium">Notes:</span>
                                <span class="text-gray-900">{{ po.notes|default:"No notes" }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- PO Items -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6">Order Items</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ordered</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Type</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Received</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Pending</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unit Price</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for item in items %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-4">
                                        <div class="font-medium text-gray-900">{{ item.product.name }}</div>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ item.product.sku }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-900">{{ item.quantity_ordered }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-900">
                                        <span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                            {{ item.get_unit_type_display }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm text-gray-900">{{ item.quantity_received }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-900">{{ item.quantity_pending }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-900">${{ item.unit_price|floatformat:2 }}</td>
                                    <td class="px-4 py-4 text-sm font-medium text-gray-900">${{ item.total_price|floatformat:2 }}</td>
                                    <td class="px-4 py-4">
                                        {% if item.is_fully_received %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Complete</span>
                                        {% elif item.quantity_received > 0 %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Partial</span>
                                        {% else %}
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Pending</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="9" class="px-4 py-8 text-center text-gray-500">No items found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Invoices Section -->
                {% if invoices %}
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6">Purchase Invoices</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Supplier Invoice #</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Invoice Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for invoice in invoices %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-4 text-sm font-medium text-gray-900">{{ invoice.invoice_number }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ invoice.supplier_invoice_number|default:"-" }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ invoice.invoice_date|date:"M d, Y" }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ invoice.due_date|date:"M d, Y" }}</td>
                                    <td class="px-4 py-4 text-sm font-medium text-gray-900">${{ invoice.amount|floatformat:2 }}</td>
                                    <td class="px-4 py-4">
                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full {% if invoice.payment_status == 'paid' %}bg-green-100 text-green-800{% elif invoice.payment_status == 'overdue' %}bg-red-100 text-red-800{% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                            {{ invoice.get_payment_status_display }}
                                        </span>
                                    </td>
                                    <td class="px-4 py-4 text-sm font-medium">
                                        <div class="flex space-x-2">
                                            {% if invoice.payment_status != 'paid' %}
                                                <a href="{% url 'purchases:mark_invoice_paid' invoice.pk %}" class="text-green-600 hover:text-green-800">Mark Paid</a>
                                            {% endif %}
                                            <a href="{% url 'purchases:download_invoice_pdf' invoice.pk %}" class="text-purple-600 hover:text-purple-800" title="Download PDF">
                                                <i class="fas fa-download"></i> PDF
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}

                <!-- Goods Receipts Section -->
                {% if receipts %}
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <h2 class="text-xl font-semibold mb-6">Goods Receipts</h2>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Receipt Number</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Received Date</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Received By</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Notes</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                {% for receipt in receipts %}
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-4 text-sm font-medium text-gray-900">{{ receipt.receipt_number }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ receipt.received_date|date:"M d, Y g:i A" }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ receipt.received_by.get_full_name|default:receipt.received_by.username }}</td>
                                    <td class="px-4 py-4 text-sm text-gray-500">{{ receipt.notes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Sidebar Actions -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-lg p-6 sticky top-8">
                    <h2 class="text-xl font-semibold mb-6">Actions</h2>
                    <div class="space-y-3">
                        {% if po.status == 'draft' %}
                            <a href="{% url 'purchases:send_to_supplier' po.pk %}" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-paper-plane mr-2"></i> Send to Supplier
                            </a>
                        {% elif po.status == 'sent' and user.role == 'supplier' %}
                            <a href="{% url 'purchases:confirm_purchase_order' po.pk %}" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-check mr-2"></i> Confirm Order
                            </a>
                        {% elif po.status == 'confirmed' %}
                            <a href="{% url 'purchases:receive_goods' po.pk %}" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                                <i class="fas fa-truck mr-2"></i> Receive Goods
                            </a>
                        {% endif %}
                        
                        {% if po.status != 'draft' %}
                            {% comment %}
                            Only show Create Invoice button if no paid invoices exist
                            {% endcomment %}
                            {% if not has_paid_invoices %}
                                <a href="{% url 'purchases:create_invoice' po.pk %}" class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                                    <i class="fas fa-file-invoice mr-2"></i> Create Invoice
                                </a>
                            {% else %}
                                <div class="w-full bg-green-100 border border-green-300 text-green-800 px-4 py-2 rounded-lg flex items-center justify-center">
                                    <i class="fas fa-check-circle mr-2"></i> Invoice Paid - No New Invoice Needed
                                </div>
                            {% endif %}
                        {% endif %}
                        
                        <button onclick="window.print()" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200 flex items-center justify-center">
                            <i class="fas fa-print mr-2"></i> Print PO
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
