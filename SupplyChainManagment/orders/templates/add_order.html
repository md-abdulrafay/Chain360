{% extends "blank.html" %}
{% load get_item %}
{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Add Order</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inventory data from Django context
            const inventory = {{ inventory|safe }};
            
            // Product pricing data for real-time calculation
            const productPricing = {
                {% for product in products %}
                '{{ product.id }}': {
                    'selling_price': {{ product.selling_price|default:0 }},
                    'cost_price': {{ product.cost_price|default:0 }},
                    'profit_margin': {{ product.profit_margin|default:0 }}
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            };
            
            function updateOrderSummary() {
                let totalValue = 0;
                let totalProfit = 0;
                
                document.querySelectorAll('input[type="number"][name^="quantity_"]').forEach(function(input) {
                    const productId = input.name.split('_')[1];
                    const quantity = parseInt(input.value) || 0;
                    const pricing = productPricing[productId];
                    
                    if (pricing && quantity > 0) {
                        totalValue += quantity * pricing.selling_price;
                        totalProfit += quantity * pricing.profit_margin;
                    }
                });
                
                document.getElementById('total-value').textContent = '$' + totalValue.toFixed(2);
                document.getElementById('total-profit').textContent = '$' + totalProfit.toFixed(2);
            }
            
            // Add event listeners to all quantity inputs
            document.querySelectorAll('input[type="number"][name^="quantity_"]').forEach(function(input) {
                input.addEventListener('input', function() {
                    const productId = this.name.split('_')[1];
                    const maxQty = inventory[productId] || 0;
                    if (parseInt(this.value) > maxQty) {
                        alert('Selected quantity exceeds available inventory (' + maxQty + ').');
                        this.value = maxQty;
                    }
                    updateOrderSummary();
                });
            });
            
            // Initial calculation
            updateOrderSummary();
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow w-full max-w-4xl flex">
        <!-- Sidebar with products -->
        <div class="w-1/2 pr-8 border-r">
            <h2 class="text-lg font-bold mb-4">Add Products in Order</h2>
            <form id="orderForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    {% for product in products %}
                    <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                        <div class="flex-1">
                            <div class="font-medium text-gray-900">{{ product.name }}</div>
                            <span class="text-xs text-gray-500">({{ inventory_units|get_item:product.id|default:"pcs" }})</span>
                            <div class="text-xs text-green-600">Available: {{ inventory|get_item:product.id|default:0 }} {{ inventory_units|get_item:product.id|default:"pcs" }}</div>
                            <div class="text-xs text-blue-600">Selling Price: ${{ product.selling_price|floatformat:2 }}</div>
                            {% if product.cost_price %}
                                <div class="text-xs text-gray-500">Cost: ${{ product.cost_price|floatformat:2 }} | Profit: ${{ product.profit_margin|floatformat:2 }}</div>
                            {% endif %}
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">Qty:</span>
                            <input type="number" name="quantity_{{ product.id }}" min="0" value="0" class="w-20 px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500" placeholder="0">
                        </div>
                    </div>
                    {% endfor %}
                </div>
        </div>
        <!-- Order details -->
        <div class="w-1/2 pl-8">
            <h2 class="text-lg font-bold mb-4">Customer Order Details</h2>
            
            <!-- Order Summary -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h3 class="font-semibold mb-2">Order Summary</h3>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between">
                        <span>Total Value:</span>
                        <span id="total-value" class="font-semibold text-green-600">$0.00</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Expected Profit:</span>
                        <span id="total-profit" class="font-semibold text-blue-600">$0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Customer Name</label>
                <input type="text" name="customer_name" class="w-full px-3 py-2 border rounded" placeholder="Enter customer name or leave blank for walk-in customer">
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Status</label>
                <select name="status" class="w-full px-3 py-2 border rounded">
                    <option value="pending">Pending</option>
                    <option value="approved">Approved</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Order Date</label>
                <input type="date" name="order_date" class="w-full px-3 py-2 border rounded" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Place Order</button>
            </form>
            <a href="{% url 'order_list' %}" class="block mt-4 text-sm text-center text-blue-600 hover:underline">‚Üê Back to Orders</a>
        </div>
    </div>
</body>
</html>
{% endblock %}
