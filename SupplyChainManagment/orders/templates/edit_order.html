{% extends "blank.html" %}
{% load order_extras %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Edit Multi-Product Order</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inventory and order_items data from Django context
            const inventory = {{ inventory|safe }};
            const orderItems = {{ order_items|safe }};
            // Add event listeners to all quantity inputs
            document.querySelectorAll('input[type="number"][name^="quantity_"]').forEach(function(input) {
                input.addEventListener('input', function() {
                    const productId = this.name.split('_')[1];
                    const maxQty = (inventory[productId] || 0) + (orderItems[productId] || 0);
                    if (parseInt(this.value) > maxQty) {
                        alert('Selected quantity exceeds available inventory (' + maxQty + ').');
                        this.value = maxQty;
                    }
                });
            });
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow w-full max-w-4xl flex">
        <!-- Sidebar with products -->
        <div class="w-1/2 pr-8 border-r">
            <h2 class="text-lg font-bold mb-4">Edit Products in Order</h2>
            <form id="orderForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    {% for product in products %}
                    <div class="flex items-center justify-between">
                        <div>
                            <span class="font-medium">{{ product.name }}</span>
                            <span class="text-xs text-gray-500">({{ product.get_unit_type_display }})</span>
                            <span class="block text-xs text-green-600 mt-1">Available: {{ inventory|get_item:product.id|default:0 }}</span>
                        </div>
                        <input type="number" name="quantity_{{ product.id }}" min="0" value="{{ order_items|get_item:product.id }}" class="w-20 px-2 py-1 border rounded" placeholder="Qty">
                    </div>
                    {% endfor %}
                </div>
        </div>
        <!-- Order details -->
        <div class="w-1/2 pl-8">
            <h2 class="text-lg font-bold mb-4">Order Details</h2>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Supplier</label>
                <select name="supplier" class="w-full px-3 py-2 border rounded" required>
                    <option value="">Select Supplier</option>
                    {% for supplier in suppliers %}
                    <option value="{{ supplier.id }}" {% if supplier.id == order.supplier.id %}selected{% endif %}>{{ supplier.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Status</label>
                <select name="status" class="w-full px-3 py-2 border rounded">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if order.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Order Date</label>
                <input type="date" name="order_date" class="w-full px-3 py-2 border rounded" value="{{ order.order_date|date:'Y-m-d' }}" required>
            </div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Update Order</button>
            </form>
            <a href="{% url 'order_list' %}" class="block mt-4 text-sm text-center text-blue-600 hover:underline">‚Üê Back to Orders</a>
        </div>
    </div>
</body>
</html>
{% endblock %}
