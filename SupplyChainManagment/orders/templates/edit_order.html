{% extends "blank.html" %}
{% load order_extras %}
{% load get_item %}

{% block content %}
<!DOCTYPE html>
<html>
<head>
    <title>Edit Multi-Product Order</title>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            function updateOrderSummary() {
                let totalValue = 0;
                let totalProfit = 0;
                
                document.querySelectorAll('input[type="number"][name^="quantity_"]').forEach(function(input) {
                    const quantity = parseInt(input.value) || 0;
                    const unitPrice = parseFloat(input.getAttribute('data-unit-price')) || 0;
                    const costPrice = parseFloat(input.getAttribute('data-cost-price')) || 0;
                    
                    if (quantity > 0) {
                        totalValue += quantity * unitPrice;
                        totalProfit += quantity * (unitPrice - costPrice);
                    }
                });
                
                document.getElementById('total-value').textContent = '$' + totalValue.toFixed(2);
                document.getElementById('total-profit').textContent = '$' + totalProfit.toFixed(2);
            }
            
            // Add event listeners to all quantity inputs
            document.querySelectorAll('input[type="number"][name^="quantity_"]').forEach(function(input) {
                input.addEventListener('input', function() {
                    const maxQty = parseInt(this.getAttribute('data-max-qty')) || 0;
                    if (parseInt(this.value) > maxQty) {
                        alert('Selected quantity exceeds available inventory (' + maxQty + ').');
                        this.value = maxQty;
                    }
                    updateOrderSummary();
                });
            });
            
            // Initial calculation
            updateOrderSummary();
        });
    </script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-xl shadow w-full max-w-4xl flex">
        <!-- Sidebar with products -->
        <div class="w-1/2 pr-8 border-r">
            <h2 class="text-lg font-bold mb-4">Edit Products in Order</h2>
            <form id="orderForm" method="post">
                {% csrf_token %}
                <div class="space-y-4">
                    {% for product in products %}
                    <!-- Show each inventory unit as a separate option -->
                    {% for product_id, inv_items in inventory_by_product.items %}
                        {% if product_id == product.id %}
                            {% for inv_item in inv_items %}
                                <!-- Always show items that are in current order or have available inventory -->
                        <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50">
                            <div class="flex-1">
                                <div class="font-medium text-gray-900">{{ product.name }}</div>
                                <div class="text-xs text-gray-500">SKU: {{ product.sku }}</div>
                                <div class="text-xs">
                                    <span class="inline-flex px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded-full">
                                        {{ inv_item.unit_display }}
                                    </span>
                                </div>
                                <div class="text-xs text-green-600 mt-1">
                                    {% if inv_item.current_order_qty > 0 %}
                                        Available: {{ inv_item.quantity }} {{ inv_item.unit_display }} ({{ inv_item.current_order_qty }} in current order)
                                    {% else %}
                                        Available: {{ inv_item.quantity }} {{ inv_item.unit_display }}
                                    {% endif %}
                                </div>
                                <div class="text-xs text-blue-600">Selling Price: ${{ inv_item.selling_price|floatformat:2 }} per {{ inv_item.unit_display }}</div>
                                {% if inv_item.cost_price %}
                                    <div class="text-xs text-gray-500">Cost: ${{ inv_item.cost_price|floatformat:2 }} | Profit: ${{ inv_item.profit_margin|floatformat:2 }}</div>
                                {% endif %}
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-sm text-gray-600">Qty:</span>
                                <input type="number" 
                                       name="quantity_{{ product.id }}_{{ inv_item.id }}" 
                                       min="0" 
                                       max="{{ inv_item.quantity }}"
                                       value="{{ inv_item.current_order_qty|default:0 }}" 
                                       class="w-20 px-2 py-1 border rounded focus:ring-2 focus:ring-blue-500" 
                                       placeholder="0"
                                       data-product-id="{{ product.id }}"
                                       data-inventory-id="{{ inv_item.id }}"
                                       data-unit-price="{{ inv_item.selling_price }}"
                                       data-cost-price="{{ inv_item.cost_price|default:0 }}"
                                       data-max-qty="{{ inv_item.quantity }}">
                            </div>
                        </div>
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                    {% empty %}
                    <div class="p-3 border rounded-lg bg-red-50">
                        <div class="font-medium text-gray-900">{{ product.name }}</div>
                        <div class="text-xs text-red-600">No inventory available</div>
                    </div>
                    {% endfor %}
                </div>
        </div>
        <!-- Order details -->
        <div class="w-1/2 pl-8">
            <h2 class="text-lg font-bold mb-4">Customer Order Details</h2>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Customer Name</label>
                <input type="text" name="customer_name" value="{{ order.customer_name|default:'' }}" class="w-full px-3 py-2 border rounded" placeholder="Enter customer name or leave blank for walk-in customer">
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Email</label>
                <input type="email" name="customer_email" value="{{ order.customer_email|default:'' }}" class="w-full px-3 py-2 border rounded" placeholder="Enter customer email">
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Phone</label>
                <input type="text" name="customer_phone" value="{{ order.customer_phone|default:'' }}" class="w-full px-3 py-2 border rounded" placeholder="Enter customer phone number">
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Address</label>
                <textarea name="customer_address" rows="3" class="w-full px-3 py-2 border rounded" placeholder="Enter customer shipping address">{{ order.customer_address|default:'' }}</textarea>
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Status</label>
                <select name="status" class="w-full px-3 py-2 border rounded">
                    <option value="pending" {% if order.status == 'pending' %}selected{% endif %}>Pending</option>
                    <option value="approved" {% if order.status == 'approved' %}selected{% endif %}>Approved</option>
                    <option value="shipped" {% if order.status == 'shipped' %}selected{% endif %}>Shipped</option>
                    <option value="delivered" {% if order.status == 'delivered' %}selected{% endif %}>Delivered</option>
                    <option value="cancelled" {% if order.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block mb-1 text-sm font-medium text-gray-700">Order Date</label>
                <input type="date" name="order_date" class="w-full px-3 py-2 border rounded" value="{{ order.order_date|date:'Y-m-d' }}" required>
            </div>
            
            <!-- Order Summary -->
            <div class="mb-4 p-3 bg-gray-50 rounded">
                <h3 class="font-semibold mb-2">Order Summary</h3>
                <div class="text-sm space-y-1">
                    <div class="flex justify-between">
                        <span>Total Value:</span>
                        <span id="total-value" class="font-semibold text-green-600">${{ order.calculated_total_value|floatformat:2|default:"0.00" }}</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Expected Profit:</span>
                        <span id="total-profit" class="font-semibold text-blue-600">${{ order.calculated_total_profit|floatformat:2|default:"0.00" }}</span>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Update Order</button>
            </form>
            <a href="{% url 'order_list' %}" class="block mt-4 text-sm text-center text-blue-600 hover:underline">‚Üê Back to Orders</a>
        </div>
    </div>
</body>
</html>
{% endblock %}
